import pickle

from api import Features, ScoringDecision, ScoringResult
from calculator import Calculator


class Model(object):
    """Класс модели с рассчетом proba и результата скоринга."""

    _threshold = 0.156

    def __init__(self, model_path: str) -> None:
        with open(model_path, 'rb') as pickled_model:
            self._model = pickle.load(pickled_model)
        self._calculator = Calculator()

    def save_model(self, file_path: str) -> None:
        """Сохраняет модель."""
        with open(file_path, 'wb') as model_file:
            pickle.dump(self, model_file)

    def get_scoring_result(self, features: Features):
        """Составляет ответ модели."""
        proba = self._predict_proba(features)

        decision = ScoringDecision.declined
        amount = 0
        if proba < self._threshold:
            decision = ScoringDecision.accepted
            amount = self._calculator.calc_amount(
                proba,
                features,
            )

        return ScoringResult(
            decision=decision,
            amount=amount,
            threshold=self._threshold,
            proba=proba,
        )

    def _predict_proba(self, features: Features) -> float:
        return self._model.predict_proba([
            features.count_doc,
            features.age,
            features.year_change_doc,
            features.diff_age_change_doc,
            features.fraq_credit_income,
            features.child_per_adult,
            features.income_per_child,
            features.income_per_adult,
            features.interest_rate,
            features.weighted_ext_scores,
            features.diff_amt_client_amt_group,
            features.count_open_credits,
            features.ratio_open_credits,
            features.month_close,
            features.month_active,
            features.max_amt_overdue,
            features.min_amt_overdue,
            features.ratio_active_credits,
            features.count_Another_type_of_loan,
            features.count_Car_loan,
            features.count_Cash_loan_nonearmarked,
            features.count_Consumer_credit,
            features.count_Interbank_credit,
            features.count_Loan_for_business_development,
            features.count_Loan_for_purchase_of_shares_margin_lending,
            features.count_Loan_for_the_purchase_of_equipment,
            features.count_Loan_for_working_capital_replenishment,
            features.count_Microloan,
            features.count_Mobile_operator_loan,
            features.count_Mortgage,
            features.count_Real_estate_loan,
            features.count_Unknown_type_of_loan,
            features.count_overdue_Another_type_of_loan,
            features.count_overdue_Car_loan,
            features.count_overdue_Consumer_credit,
            features.count_overdue_Credit_card,
            features.count_overdue_Loan_for_business_development,
            features.count_overdue_Loan_for_working_capital_replenishment,
            features.count_overdue_Microloan,
            features.count_overdue_Mortgage,
            features.count_closed_Another_type_of_loan,
            features.count_closed_Car_loan,
            features.count_closed_Cash_loan_nonearmarked,
            features.count_closed_Consumer_credit,
            features.count_closed_Credit_card,
            features.count_closed_Interbank_credit,
            features.count_closed_Loan_for_business_development,
            features.count_closed_Loan_for_purchase_of_shares_margin_lending,
            features.count_closed_Loan_for_the_purchase_of_equipment,
            features.count_closed_Loan_for_working_capital_replenishment,
            features.count_closed_Microloan,
            features.count_closed_Mortgage,
            features.count_closed_Real_estate_loan,
            features.count_closed_Unknown_type_of_loan,
            features.amt_annuity_max,
            features.amt_annuity_min,
            features.amt_annuity_mean,
            features.amt_annuity_median,
            features.amt_annuity_sum,
            features.amt_annuity_std,
            features.amt_application_max,
            features.amt_application_min,
            features.amt_application_mean,
            features.amt_application_median,
            features.amt_credit_min,
            features.amt_credit_mean,
            features.amt_credit_median,
            features.amt_down_payment_max,
            features.amt_down_payment_min,
            features.amt_down_payment_mean,
            features.amt_down_payment_median,
            features.amt_down_payment_sum,
            features.amt_down_payment_std,
            features.amt_goods_price_max,
            features.amt_goods_price_min,
            features.amt_goods_price_mean,
            features.amt_goods_price_median,
            features.flag_last_appl_per_contract_sum,
            features.nflag_last_appl_in_day_sum,
            features.nflag_insured_on_approval_sum,
            features.rate_down_payment_mean,
            features.rate_down_payment_median,
            features.days_first_drawing_min,
            features.days_first_drawing_max,
            features.days_first_due_min,
            features.days_first_due_max,
            features.days_last_due_min,
            features.days_last_due_max,
            features.cnt_instalment_future_mean_all,
            features.cnt_instalment_future_sum_all,
            features.cnt_instalment_mean_all,
            features.cnt_instalment_sum_all,
            features.sk_dpd_mean_all,
            features.sk_dpd_sum_all,
            features.sk_dpd_def_mean_all,
            features.sk_dpd_def_sum_all,
            features.cnt_instalment_future_mean_3years,
            features.cnt_instalment_future_sum_3years,
            features.cnt_instalment_mean_3years,
            features.cnt_instalment_sum_3years,
            features.sk_dpd_mean_3years,
            features.sk_dpd_sum_3years,
            features.sk_dpd_def_mean_3years,
            features.sk_dpd_def_sum_3years,
            features.num_instalment_number,
            features.flag_overdue,
            features.flag_overdue_amt,
            features.amt_balance_max,
            features.amt_balance_min,
            features.amt_balance_mean,
            features.amt_balance_median,
            features.amt_balance_sum,
            features.amt_balance_var,
            features.amt_balance_std,
            features.amt_credit_limit_actual_max,
            features.amt_credit_limit_actual_min,
            features.amt_credit_limit_actual_mean,
            features.amt_credit_limit_actual_median,
            features.amt_credit_limit_actual_sum,
            features.amt_credit_limit_actual_var,
            features.amt_credit_limit_actual_std,
            features.amt_drawings_atm_current_max,
            features.amt_drawings_atm_current_min,
            features.amt_drawings_atm_current_mean,
            features.amt_drawings_atm_current_median,
            features.amt_drawings_atm_current_sum,
            features.amt_drawings_atm_current_var,
            features.amt_drawings_atm_current_std,
            features.amt_drawings_current_max,
            features.amt_drawings_current_min,
            features.amt_drawings_current_mean,
            features.amt_drawings_current_median,
            features.amt_drawings_current_sum,
            features.amt_drawings_current_var,
            features.amt_drawings_current_std,
            features.amt_drawings_other_current_max,
            features.amt_drawings_other_current_min,
            features.amt_drawings_other_current_mean,
            features.amt_drawings_other_current_median,
            features.amt_drawings_other_current_sum,
            features.amt_drawings_other_current_var,
            features.amt_drawings_other_current_std,
            features.amt_drawings_pos_current_max,
            features.amt_drawings_pos_current_min,
            features.amt_drawings_pos_current_mean,
            features.amt_drawings_pos_current_median,
            features.amt_drawings_pos_current_sum,
            features.amt_drawings_pos_current_var,
            features.amt_drawings_pos_current_std,
            features.amt_inst_min_regularity_max,
            features.amt_inst_min_regularity_min,
            features.amt_inst_min_regularity_mean,
            features.amt_inst_min_regularity_median,
            features.amt_inst_min_regularity_sum,
            features.amt_inst_min_regularity_var,
            features.amt_inst_min_regularity_std,
            features.amt_payment_current_max,
            features.amt_payment_current_min,
            features.amt_payment_current_mean,
            features.amt_payment_current_median,
            features.amt_payment_current_sum,
            features.amt_payment_current_var,
            features.amt_payment_current_std,
            features.amt_payment_total_current_max,
            features.amt_payment_total_current_min,
            features.amt_payment_total_current_mean,
            features.amt_payment_total_current_median,
            features.amt_payment_total_current_sum,
            features.amt_payment_total_current_var,
            features.amt_payment_total_current_std,
            features.amt_receivable_principal_max,
            features.amt_receivable_principal_min,
            features.amt_receivable_principal_mean,
            features.amt_receivable_principal_median,
            features.amt_receivable_principal_sum,
            features.amt_receivable_principal_var,
            features.amt_receivable_principal_std,
            features.amt_recivable_max,
            features.amt_recivable_min,
            features.amt_recivable_mean,
            features.amt_recivable_median,
            features.amt_recivable_sum,
            features.amt_recivable_var,
            features.amt_recivable_std,
            features.amt_total_receivable_max,
            features.amt_total_receivable_min,
            features.amt_total_receivable_mean,
            features.amt_total_receivable_median,
            features.amt_total_receivable_sum,
            features.amt_total_receivable_var,
            features.amt_total_receivable_std,
            features.cnt_drawings_atm_current_max,
            features.cnt_drawings_atm_current_min,
            features.cnt_drawings_atm_current_mean,
            features.cnt_drawings_atm_current_median,
            features.cnt_drawings_atm_current_sum,
            features.cnt_drawings_atm_current_var,
            features.cnt_drawings_atm_current_std,
            features.cnt_drawings_current_max,
            features.cnt_drawings_current_min,
            features.cnt_drawings_current_mean,
            features.cnt_drawings_current_median,
            features.cnt_drawings_current_sum,
            features.cnt_drawings_current_var,
            features.cnt_drawings_current_std,
            features.cnt_drawings_other_current_max,
            features.cnt_drawings_other_current_min,
            features.cnt_drawings_other_current_mean,
            features.cnt_drawings_other_current_median,
            features.cnt_drawings_other_current_sum,
            features.cnt_drawings_other_current_var,
            features.cnt_drawings_other_current_std,
            features.cnt_drawings_pos_current_max,
            features.cnt_drawings_pos_current_min,
            features.cnt_drawings_pos_current_mean,
            features.cnt_drawings_pos_current_median,
            features.cnt_drawings_pos_current_sum,
            features.cnt_drawings_pos_current_var,
            features.cnt_drawings_pos_current_std,
            features.cnt_instalment_mature_cum_max,
            features.cnt_instalment_mature_cum_min,
            features.cnt_instalment_mature_cum_mean,
            features.cnt_instalment_mature_cum_median,
            features.cnt_instalment_mature_cum_sum,
            features.cnt_instalment_mature_cum_var,
            features.cnt_instalment_mature_cum_std,
            features.sk_dpd_max,
            features.sk_dpd_min,
            features.sk_dpd_mean,
            features.sk_dpd_median,
            features.sk_dpd_sum,
            features.sk_dpd_var,
            features.sk_dpd_std,
            features.sk_dpd_def_max,
            features.sk_dpd_def_min,
            features.sk_dpd_def_mean,
            features.sk_dpd_def_median,
            features.sk_dpd_def_sum,
            features.sk_dpd_def_var,
            features.sk_dpd_def_std,
            features.amt_balance_max_diff_3m,
            features.amt_balance_min_diff_3m,
            features.amt_balance_mean_diff_3m,
            features.amt_balance_median_diff_3m,
            features.amt_balance_sum_diff_3m,
            features.amt_balance_var_diff_3m,
            features.amt_balance_std_diff_3m,
            features.amt_credit_limit_actual_max_diff_3m,
            features.amt_credit_limit_actual_min_diff_3m,
            features.amt_credit_limit_actual_mean_diff_3m,
            features.amt_credit_limit_actual_median_diff_3m,
            features.amt_credit_limit_actual_sum_diff_3m,
            features.amt_credit_limit_actual_var_diff_3m,
            features.amt_credit_limit_actual_std_diff_3m,
            features.amt_drawings_atm_current_max_diff_3m,
            features.amt_drawings_atm_current_min_diff_3m,
            features.amt_drawings_atm_current_mean_diff_3m,
            features.amt_drawings_atm_current_median_diff_3m,
            features.amt_drawings_atm_current_sum_diff_3m,
            features.amt_drawings_atm_current_var_diff_3m,
            features.amt_drawings_atm_current_std_diff_3m,
            features.amt_drawings_current_max_diff_3m,
            features.amt_drawings_current_min_diff_3m,
            features.amt_drawings_current_mean_diff_3m,
            features.amt_drawings_current_median_diff_3m,
            features.amt_drawings_current_sum_diff_3m,
            features.amt_drawings_current_var_diff_3m,
            features.amt_drawings_current_std_diff_3m,
            features.amt_drawings_other_current_max_diff_3m,
            features.amt_drawings_other_current_min_diff_3m,
            features.amt_drawings_other_current_mean_diff_3m,
            features.amt_drawings_other_current_median_diff_3m,
            features.amt_drawings_other_current_sum_diff_3m,
            features.amt_drawings_other_current_var_diff_3m,
            features.amt_drawings_other_current_std_diff_3m,
            features.amt_drawings_pos_current_max_diff_3m,
            features.amt_drawings_pos_current_min_diff_3m,
            features.amt_drawings_pos_current_mean_diff_3m,
            features.amt_drawings_pos_current_median_diff_3m,
            features.amt_drawings_pos_current_sum_diff_3m,
            features.amt_drawings_pos_current_var_diff_3m,
            features.amt_drawings_pos_current_std_diff_3m,
            features.amt_inst_min_regularity_max_diff_3m,
            features.amt_inst_min_regularity_min_diff_3m,
            features.amt_inst_min_regularity_mean_diff_3m,
            features.amt_inst_min_regularity_median_diff_3m,
            features.amt_inst_min_regularity_sum_diff_3m,
            features.amt_inst_min_regularity_var_diff_3m,
            features.amt_inst_min_regularity_std_diff_3m,
            features.amt_payment_current_max_diff_3m,
            features.amt_payment_current_min_diff_3m,
            features.amt_payment_current_mean_diff_3m,
            features.amt_payment_current_median_diff_3m,
            features.amt_payment_current_sum_diff_3m,
            features.amt_payment_current_var_diff_3m,
            features.amt_payment_current_std_diff_3m,
            features.amt_payment_total_current_max_diff_3m,
            features.amt_payment_total_current_min_diff_3m,
            features.amt_payment_total_current_mean_diff_3m,
            features.amt_payment_total_current_median_diff_3m,
            features.amt_payment_total_current_sum_diff_3m,
            features.amt_payment_total_current_var_diff_3m,
            features.amt_payment_total_current_std_diff_3m,
            features.amt_receivable_principal_max_diff_3m,
            features.amt_receivable_principal_min_diff_3m,
            features.amt_receivable_principal_mean_diff_3m,
            features.amt_receivable_principal_median_diff_3m,
            features.amt_receivable_principal_sum_diff_3m,
            features.amt_receivable_principal_var_diff_3m,
            features.amt_receivable_principal_std_diff_3m,
            features.amt_recivable_max_diff_3m,
            features.amt_recivable_min_diff_3m,
            features.amt_recivable_mean_diff_3m,
            features.amt_recivable_median_diff_3m,
            features.amt_recivable_sum_diff_3m,
            features.amt_recivable_var_diff_3m,
            features.amt_recivable_std_diff_3m,
            features.amt_total_receivable_max_diff_3m,
            features.amt_total_receivable_min_diff_3m,
            features.amt_total_receivable_mean_diff_3m,
            features.amt_total_receivable_median_diff_3m,
            features.amt_total_receivable_sum_diff_3m,
            features.amt_total_receivable_var_diff_3m,
            features.amt_total_receivable_std_diff_3m,
            features.cnt_drawings_atm_current_max_diff_3m,
            features.cnt_drawings_atm_current_min_diff_3m,
            features.cnt_drawings_atm_current_mean_diff_3m,
            features.cnt_drawings_atm_current_median_diff_3m,
            features.cnt_drawings_atm_current_sum_diff_3m,
            features.cnt_drawings_atm_current_var_diff_3m,
            features.cnt_drawings_atm_current_std_diff_3m,
            features.cnt_drawings_current_max_diff_3m,
            features.cnt_drawings_current_min_diff_3m,
            features.cnt_drawings_current_mean_diff_3m,
            features.cnt_drawings_current_median_diff_3m,
            features.cnt_drawings_current_sum_diff_3m,
            features.cnt_drawings_current_var_diff_3m,
            features.cnt_drawings_current_std_diff_3m,
            features.cnt_drawings_other_current_max_diff_3m,
            features.cnt_drawings_other_current_min_diff_3m,
            features.cnt_drawings_other_current_mean_diff_3m,
            features.cnt_drawings_other_current_median_diff_3m,
            features.cnt_drawings_other_current_sum_diff_3m,
            features.cnt_drawings_other_current_var_diff_3m,
            features.cnt_drawings_other_current_std_diff_3m,
            features.cnt_drawings_pos_current_max_diff_3m,
            features.cnt_drawings_pos_current_min_diff_3m,
            features.cnt_drawings_pos_current_mean_diff_3m,
            features.cnt_drawings_pos_current_median_diff_3m,
            features.cnt_drawings_pos_current_sum_diff_3m,
            features.cnt_drawings_pos_current_var_diff_3m,
            features.cnt_drawings_pos_current_std_diff_3m,
            features.cnt_instalment_mature_cum_max_diff_3m,
            features.cnt_instalment_mature_cum_min_diff_3m,
            features.cnt_instalment_mature_cum_mean_diff_3m,
            features.cnt_instalment_mature_cum_median_diff_3m,
            features.cnt_instalment_mature_cum_sum_diff_3m,
            features.cnt_instalment_mature_cum_var_diff_3m,
            features.cnt_instalment_mature_cum_std_diff_3m,
            features.sk_dpd_max_diff_3m,
            features.sk_dpd_min_diff_3m,
            features.sk_dpd_mean_diff_3m,
            features.sk_dpd_median_diff_3m,
            features.sk_dpd_sum_diff_3m,
            features.sk_dpd_var_diff_3m,
            features.sk_dpd_std_diff_3m,
            features.sk_dpd_def_max_diff_3m,
            features.sk_dpd_def_min_diff_3m,
            features.sk_dpd_def_mean_diff_3m,
            features.sk_dpd_def_median_diff_3m,
            features.sk_dpd_def_sum_diff_3m,
            features.sk_dpd_def_var_diff_3m,
            features.sk_dpd_def_std_diff_3m,
            features.flag_full_info_house,
            features.flag_delay_change_doc,
        ])[1]
